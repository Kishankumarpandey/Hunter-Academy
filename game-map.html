<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Skill Map | System Progression</title>
    
    <link rel="stylesheet" href="css/login.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Rajdhani:wght@300;500;700&display=swap" rel="stylesheet">
    
    <style>
        /* --- KEEPING YOUR EXACT CSS --- */
        :root {
            --neon-blue: #00eaff;
            --neon-red: #ff0055;
            --locked-grey: #333;
            --system-bg: rgba(2, 6, 23, 0.8);
        }

        body { overflow-y: auto; padding: 50px 0; background-attachment: fixed; }

        .map-container { max-width: 600px; margin: 0 auto; text-align: center; position: relative; z-index: 10; }

        .map-header h2 { font-family: 'Orbitron'; color: white; font-size: 2.5rem; text-shadow: 0 0 20px var(--neon-blue); letter-spacing: 3px; animation: glowHeader 3s infinite alternate; }
        .map-header p { color: #aaa; font-family: 'Rajdhani'; font-size: 1.1rem; margin-bottom: 50px; }

        /* SKILL NODE STYLES */
        .skill-node {
            width: 100%; max-width: 550px; background: rgba(10, 10, 20, 0.6); backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.1); padding: 25px; display: flex; align-items: center; justify-content: space-between;
            position: relative; clip-path: polygon(20px 0, 100% 0, 100% calc(100% - 20px), calc(100% - 20px) 100%, 0 100%, 0 20px);
            transition: all 0.3s; opacity: 0; transform: translateY(30px); animation: slideUp 0.6s forwards;
        }

        .node-wrapper:nth-child(1) .skill-node { animation-delay: 0.1s; }
        .node-wrapper:nth-child(2) .skill-node { animation-delay: 0.3s; }
        .node-wrapper:nth-child(3) .skill-node { animation-delay: 0.5s; }
        .node-wrapper:nth-child(4) .skill-node { animation-delay: 0.7s; }

        .node-left { display: flex; align-items: center; gap: 20px; }
        .node-icon { width: 65px; height: 65px; background: rgba(0,0,0,0.6); border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 1.8rem; border: 2px solid #444; color: #555; transition: 0.3s; }
        .node-info { text-align: left; }
        .node-info h3 { font-family: 'Orbitron'; color: white; font-size: 1.2rem; margin: 0 0 5px 0; }
        .node-info p { color: #888; font-size: 0.9rem; font-family: 'Rajdhani'; margin: 0; }

        /* UNLOCKED STATE */
        .skill-node.unlocked {
            border-color: var(--neon-blue); background: rgba(0, 234, 255, 0.05);
            box-shadow: 0 0 30px rgba(0, 234, 255, 0.1); animation: slideUp 0.6s forwards, floatNode 4s ease-in-out infinite;
        }
        .skill-node.unlocked .node-icon { border-color: var(--neon-blue); color: var(--neon-blue); text-shadow: 0 0 15px var(--neon-blue); }
        .status-active { color: var(--neon-blue); font-weight: bold; text-transform: uppercase; }

        .enter-btn {
            background: linear-gradient(45deg, var(--neon-blue), #00aaff); color: black; border: none; padding: 12px 25px;
            font-family: 'Orbitron'; font-weight: bold; cursor: pointer;
            clip-path: polygon(10px 0, 100% 0, 100% calc(100% - 10px), calc(100% - 10px) 100%, 0 100%, 0 10px);
            transition: 0.3s;
        }
        .enter-btn:hover { transform: scale(1.05); box-shadow: 0 0 25px var(--neon-blue); color: white; }

        /* LOCKED STATE */
        .skill-node.locked { opacity: 0.8; filter: grayscale(0.8); cursor: not-allowed; }
        .lock-overlay { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 2.5rem; color: #444; z-index: 2; opacity: 0.5; }

        /* CONNECTORS */
        .node-wrapper { display: flex; flex-direction: column; align-items: center; }
        .connector { width: 4px; height: 50px; background: #222; position: relative; z-index: 1; }
        .connector.active-path { background: linear-gradient(to bottom, var(--neon-blue), #222); box-shadow: 0 0 15px var(--neon-blue); }

        /* ANIMATIONS */
        @keyframes slideUp { to { opacity: 1; transform: translateY(0); } }
        @keyframes glowHeader { from { text-shadow: 0 0 10px var(--neon-blue); } to { text-shadow: 0 0 30px var(--neon-blue), 0 0 10px white; } }
        @keyframes floatNode { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
        @keyframes shakeError { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-10px); } 75% { transform: translateX(10px); } }
        .shake-active { animation: shakeError 0.4s ease-in-out; border-color: var(--neon-red) !important; box-shadow: 0 0 20px var(--neon-red) !important; }

    </style>
</head>
<body>

    <div class="cyber-grid"></div>
    <div class="overlay"></div>

    <div class="map-container">
        <div class="map-header">
            <h2>SYSTEM PROGRESSION</h2>
            <p>PLAYER: <span id="player-name" style="color: var(--neon-blue);">LOADING...</span></p>
        </div>

        <div class="skill-chain">

            <div class="node-wrapper">
                <div id="node-1" class="skill-node unlocked">
                    <div class="node-left">
                        <div class="node-icon"><i class="fas fa-code"></i></div>
                        <div class="node-info">
                            <h3>LVL 1: C PROGRAMMING</h3>
                            <p id="status-1">Status: <span class="status-active">Available</span></p>
                        </div>
                    </div>
                    <button class="enter-btn" onclick="location.href='level.html'">ENTER</button>
                </div>
                <div id="conn-1" class="connector active-path"></div>
            </div>

            <div class="node-wrapper">
                <div id="node-2" class="skill-node locked">
                    <div class="lock-overlay"><i class="fas fa-lock"></i></div>
                    <div class="node-left">
                        <div class="node-icon"><i class="fas fa-microchip"></i></div>
                        <div class="node-info">
                            <h3>LVL 2: MICROCONTROLLERS</h3>
                            <p id="status-2">Status: Locked (Req. LVL 1)</p>
                        </div>
                    </div>
                </div>
                <div id="conn-2" class="connector"></div>
            </div>

            <div class="node-wrapper">
                <div id="node-3" class="skill-node locked">
                    <div class="lock-overlay"><i class="fab fa-linux"></i></div>
                    <div class="node-left">
                        <div class="node-icon"><i class="fas fa-terminal"></i></div>
                        <div class="node-info">
                            <h3>LVL 3: EMBEDDED LINUX</h3>
                            <p id="status-3">Status: Locked (Req. LVL 2)</p>
                        </div>
                    </div>
                </div>
                <div id="conn-3" class="connector"></div>
            </div>

            <div class="node-wrapper">
                <div id="node-4" class="skill-node locked">
                    <div class="lock-overlay"><i class="fas fa-stopwatch"></i></div>
                    <div class="node-left">
                        <div class="node-icon"><i class="fas fa-network-wired"></i></div>
                        <div class="node-info">
                            <h3>LVL 4: RTOS ARCHITECT</h3>
                            <p id="status-4">Status: Locked (Req. LVL 3)</p>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <script type="module">
        import { auth, db } from './js/firebase-config.js';
        import { doc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                // Show Player Name
                document.getElementById('player-name').innerText = (user.displayName || "HUNTER").toUpperCase();

                // Get Data from Database
                const docRef = doc(db, "users", user.uid);
                const docSnap = await getDoc(docRef);

                if (docSnap.exists()) {
                    const data = docSnap.data();
                    
                    // CHECK PROGRESS: 'completedLevels' field ko check karega
                    // level.html me humne ye field badhaya tha.
                    const progress = data.completedLevels || 0; 

                    console.log("Current Progress:", progress);

                    // Logic to Unlock
                    if (progress >= 1) {
                        unlockNode(2); // Unlock Level 2
                    }
                    if (progress >= 2) {
                        unlockNode(3); // Unlock Level 3
                    }
                    if (progress >= 3) {
                        unlockNode(4); // Unlock Level 4
                    }
                }
            } else {
                window.location.href = 'login.html';
            }
        });

        // Function to visually unlock a node
        function unlockNode(levelNum) {
            const node = document.getElementById(`node-${levelNum}`);
            const statusText = document.getElementById(`status-${levelNum}`);
            const prevConnector = document.getElementById(`conn-${levelNum - 1}`);

            // 1. Remove 'locked' class, add 'unlocked'
            node.classList.remove('locked');
            node.classList.add('unlocked');

            // 2. Remove Lock Icon overlay
            const lockOverlay = node.querySelector('.lock-overlay');
            if(lockOverlay) lockOverlay.remove();

            // 3. Update Text
            statusText.innerHTML = 'Status: <span class="status-active">Available</span>';

            // 4. Add Enter Button (avoid duplicates)
            if (!node.querySelector('.enter-btn')) {
                const btn = document.createElement('button');
                btn.className = 'enter-btn';
                btn.innerText = 'ENTER';
                
                // Link to next page (abhi dummy link hai)
                if (levelNum === 2) {
    btn.onclick = () => location.href = 'level-2.html';
} else {
    // बाकी लेवल्स के लिए अभी भी अलर्ट रहेगा
    btn.onclick = () => alert("SYSTEM: Level " + levelNum + " Under Construction.");
}
                
                node.appendChild(btn);
            }

            // 5. Glow the path connecting to it
            if (prevConnector) {
                prevConnector.classList.add('active-path');
            }
        }

        // Keep the Shake Logic for Locked items
        document.addEventListener('click', (e) => {
            if (e.target.closest('.skill-node.locked')) {
                const node = e.target.closest('.skill-node.locked');
                node.classList.add('shake-active');
                setTimeout(() => node.classList.remove('shake-active'), 500);
            }
        });

    </script>
</body>
</html>